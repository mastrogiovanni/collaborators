<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner with Validation</title>
  <style>
    video {
      width: 100%;
      max-height: 300px;
      max-width: 600px;
      border: 1px solid black;
    }

    canvas {
      display: none;
    }

    #status {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <h1>QR Code Scanner with Validation</h1>

  <div id="loadingOverlay" style="
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:white; display:flex; flex-direction:column;
  align-items:center; justify-content:center; z-index:9999;
">
    <div class="spinner" style="
    border: 8px solid #f3f3f3;
    border-top: 8px solid #3498db;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
  "></div>
    <p style="margin-top:20px; font-size:1.2em;">Loading images...</p>
  </div>

  <video id="video" autoplay></video>
  <canvas id="canvas"></canvas>
  <div id="status">Last QR status: None</div>
  <div id="cardPanel" style="margin-top:20px; width:250px; height:auto; display:none;">
    <div id="userCard" style="
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    border-radius: 15px;
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  ">
      <img id="cardImage" src="" alt=""
        style="width:100px; height:100px; border-radius:50%; border:3px solid white; margin-bottom:10px;">
      <h2 id="cardName" style="margin:10px 0 5px 0;">Name</h2>
      <p id="cardRole" style="margin:0; font-weight:bold;">Role</p>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl/nacl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util/nacl-util.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');

    
    const userDictionary = {
      "abc1": {
        name: "Michele Mastrogiovanni",
        role: "CEO",
        image: "images/face1.jpeg"
      },
      "abc2": {
        name: "Rolando Capasso",
        role: "Capo Cantiere",
        image: "images/face2.jpeg"
      },
    };

    let preloadedImages = {}

    
    function preloadImages(dictionary, callback) {
      const keys = Object.keys(dictionary);
      let loaded = 0;

      for (const key of keys) {
        const img = new Image();
        img.onload = () => {
          loaded++;
          if (loaded === keys.length) {
            callback();
          }
        };
        img.onerror = () => {
          console.warn("Failed to load image for key:", key);
          loaded++;
          if (loaded === keys.length) {
            callback();
          }
        };
        img.src = dictionary[key].image;
        preloadedImages[key] = img;
      }
    }

    
    preloadImages(userDictionary, () => {
      console.log("All images preloaded!");
      document.getElementById("loadingOverlay").style.display = "none"; 

      
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(err => console.error("Error accessing webcam: ", err));
    });

    function hexToUint8Array(hex) {
      if (hex.length % 2 !== 0) {
        throw new Error("Invalid hex string");
      }
      const array = new Uint8Array(hex.length / 2);
      for (let i = 0; i < hex.length; i += 2) {
        array[i / 2] = parseInt(hex.substr(i, 2), 16);
      }
      return array;
    }

    function stringToUint8Array(str) {
      const encoder = new TextEncoder(); 
      return encoder.encode(str);
    }

    
    const PUBLIC_KEY_HEX = "e58e949473ef4c23e62100a8439d8fda3d13b3008f6a8d59378d52b0a541df98";
    const publicKey = hexToUint8Array(PUBLIC_KEY_HEX);

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          console.log("QR Code detected: ", code.data);
          validateQR(code.data);
          drawRect(code.location);
        }
      }
      requestAnimationFrame(tick);
    }

    function drawRect(location) {
      ctx.beginPath();
      ctx.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
      ctx.lineTo(location.topRightCorner.x, location.topRightCorner.y);
      ctx.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
      ctx.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
      ctx.closePath();
      ctx.lineWidth = 4;
      ctx.strokeStyle = "red";
      ctx.stroke();
    }

    function validateQR(data) {
      const parts = data.split("-");

      const cardPanel = document.getElementById("cardPanel");
      const cardImage = document.getElementById("cardImage");
      const cardName = document.getElementById("cardName");
      const cardRole = document.getElementById("cardRole");

      if (parts.length !== 2) {
        console.log("Invalid QR format");
        statusDiv.textContent = "Last QR status: Invalid format";
        cardPanel.style.display = "none";
        return;
      }

      const payloadHex = parts[0];
      const signatureHex = parts[1];

      try {
        const payload = stringToUint8Array(payloadHex);
        const signature = hexToUint8Array(signatureHex);

        const isValid = nacl.sign.detached.verify(payload, signature, publicKey);
        console.log("QR validation result:", isValid ? "VALID" : "NOT VALID");
        statusDiv.textContent = "Last QR status: " + (isValid ? "VALID" : "NOT VALID");

        if (isValid && preloadedImages[payloadHex]) {
          const user = userDictionary[payloadHex];
          cardImage.src = user.image;
          cardName.textContent = user.name;
          cardRole.textContent = user.role;
          cardPanel.style.display = "block";
        } else {
          cardPanel.style.display = "none";
        }
      } catch (err) {
        console.log("Error decoding QR:", err);
        statusDiv.textContent = "Last QR status: Error decoding QR";
        cardPanel.style.display = "none";
      }
    }
  </script>
</body>

</html>